name: Update README Version

on:
  push:
    paths:
      - '.claude-plugin/marketplace.json'
      - 'oracle-skills/.claude-plugin/marketplace.json'
      - 'ralph-soulbrews/.claude-plugin/plugin.json'
    branches:
      - main
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract versions
        id: versions
        run: |
          MARKETPLACE_VERSION=$(jq -r '.version' .claude-plugin/marketplace.json)
          ORACLE_VERSION=$(jq -r '.version' oracle-skills/.claude-plugin/marketplace.json)
          RALPH_VERSION=$(jq -r '.version' ralph-soulbrews/.claude-plugin/plugin.json)
          DATE=$(date '+%Y-%m-%d')
          
          echo "marketplace=$MARKETPLACE_VERSION" >> $GITHUB_OUTPUT
          echo "oracle=$ORACLE_VERSION" >> $GITHUB_OUTPUT
          echo "ralph=$RALPH_VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          
          echo "Marketplace: $MARKETPLACE_VERSION"
          echo "Oracle Skills: $ORACLE_VERSION"
          echo "Ralph Local: $RALPH_VERSION"
          echo "Date: $DATE"
      
      - name: Update README from template
        run: |
          sed -e "s/{{MARKETPLACE_VERSION}}/${{ steps.versions.outputs.marketplace }}/g" \
              -e "s/{{ORACLE_VERSION}}/${{ steps.versions.outputs.oracle }}/g" \
              -e "s/{{RALPH_VERSION}}/${{ steps.versions.outputs.ralph }}/g" \
              -e "s/{{DATE}}/${{ steps.versions.outputs.date }}/g" \
              README.template.md > README.md
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: Update README versions (v${{ steps.versions.outputs.marketplace }})"
          git push
